{% extends 'base.html' %}
{% block content %}
<div class="d-flex flex-wrap justify-content-between align-items-center mb-4 gap-3">
  <div>
    <h1 class="h3 mb-1">Sales Dashboard</h1>
    <p class="text-muted mb-0">Recent customer transactions and payment statuses.</p>
  </div>
  <div class="d-flex flex-wrap gap-2">
    <a href="?export=pdf" class="btn btn-outline-secondary" data-export-trigger="true" data-export-type="pdf" data-table-target="#sales-table">
      <i class="bi bi-file-earmark-pdf me-1"></i> Export PDF
    </a>
    <a href="?export=excel" class="btn btn-outline-secondary" data-export-trigger="true" data-export-type="excel" data-table-target="#sales-table">
      <i class="bi bi-file-earmark-excel me-1"></i> Export Excel
    </a>
    <a href="{% url 'sales:create' %}" class="btn btn-primary">
      <i class="bi bi-cash-coin me-1"></i> Record Sale
    </a>
  </div>
</div>

<ul class="nav nav-tabs mb-3">
  <li class="nav-item">
    <a class="nav-link {% if not show_bulk %}active{% endif %}" href="{% url 'sales:dashboard' %}">All Sales</a>
  </li>
  <li class="nav-item">
    <a class="nav-link {% if show_bulk %}active{% endif %}" href="{% url 'sales:dashboard' %}?bulk=1">Bulk Sales</a>
  </li>
</ul>

<!-- Filters -->
<form method="get" class="card shadow-sm mb-4">
  <div class="card-body">
    <div class="row g-3 align-items-end">
      <div class="col-md-3">
        <label for="filter_customer" class="form-label">Customer</label>
        <input type="text" id="filter_customer" name="filter__customer" class="form-control" 
               placeholder="e.g. John or 0712345678" 
               value="{{ request.GET.filter__customer }}">
      </div>
      <div class="col-md-2">
        <label for="filter_status" class="form-label">Payment Status</label>
        <select id="filter_status" name="filter__payment_status" class="form-select">
          <option value="">All Statuses</option>
          <option value="paid" {% if request.GET.filter__payment_status == 'paid' %}selected{% endif %}>Paid</option>
          <option value="partial" {% if request.GET.filter__payment_status == 'partial' %}selected{% endif %}>Partial</option>
          <option value="pending" {% if request.GET.filter__payment_status == 'pending' %}selected{% endif %}>Pending</option>
        </select>
      </div>
      <div class="col-md-2">
        <label for="filter_id" class="form-label">Transaction ID</label>
        <input type="text" id="filter_id" name="filter__transaction_id" class="form-control" 
               placeholder="e.g. TXN-001" 
               value="{{ request.GET.filter__transaction_id }}">
      </div>
      <div class="col-md-2">
        <label for="filter_date" class="form-label">Date</label>
        <input type="date" id="filter_date" name="filter__created_at" class="form-control" 
               value="{{ request.GET.filter__created_at }}">
      </div>
      <div class="col-md-3 d-flex gap-2">
        <button type="submit" class="btn btn-primary flex-grow-1">
          <i class="bi bi-funnel me-1"></i> Filter
        </button>
        <a href="{% url 'sales:dashboard' %}" class="btn btn-outline-secondary">Reset</a>
      </div>
    </div>
  </div>
</form>

<div class="card shadow-sm">
  <div class="card-body p-0">
    <div class="table-responsive">
      <table id="sales-table" class="table table-striped table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th data-filter-key="transaction_id">ID</th>
            <th data-filter-key="customer">Customer</th>
            <th>Products</th>
            <th>Qty</th>
            <th data-filter-key="total_amount">Total</th>
            <th data-filter-key="payment_status">Status</th>
            <th data-filter-key="created_at">Date</th>
            <th class="text-end" data-no-filter="true">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for tx in transactions %}
          <tr>
            <td class="fw-semibold"><code>{{ tx.transaction_id }}</code></td>
            <td>{{ tx.customer_display_name }}</td>
            <td>
              {% for item in tx.items.all %}
                <span class="badge bg-light text-dark me-1">{{ item.inventory_item.name }}</span>
              {% empty %}
                <span class="text-muted">—</span>
              {% endfor %}
            </td>
            <td>
              {% for item in tx.items.all %}
                <span class="badge bg-secondary me-1">{{ item.quantity|floatformat:0 }}</span>
              {% empty %}
                <span class="text-muted">—</span>
              {% endfor %}
            </td>
            <td>KES {{ tx.total_amount|floatformat:2 }}</td>
            <td>
              {% if tx.payment_status == 'paid' %}
                <span class="badge bg-success">{{ tx.get_payment_status_display }}</span>
              {% elif tx.payment_status == 'partial' %}
                <span class="badge bg-warning text-dark">{{ tx.get_payment_status_display }}</span>
              {% else %}
                <span class="badge bg-secondary">{{ tx.get_payment_status_display }}</span>
              {% endif %}
            </td>
            <td>{{ tx.created_at|date:"Y-m-d H:i" }}</td>
            <td class="text-end">
              <div class="d-flex justify-content-end flex-wrap gap-2">
                <a href="{% url 'sales:receipt' tx.id %}" target="_blank" class="btn btn-outline-info btn-sm">
                  Receipt
                </a>
                {% if perms.sales.change_salestransaction %}
                <a href="{% url 'sales:update' tx.id %}" class="btn btn-outline-primary btn-sm">
                  Edit
                </a>
                {% endif %}
                {% if perms.sales.delete_salestransaction %}
                <a href="{% url 'sales:delete' tx.id %}" class="btn btn-outline-danger btn-sm">
                  Delete
                </a>
                {% endif %}
              </div>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="8" class="text-center text-muted py-4">No sales yet.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}

