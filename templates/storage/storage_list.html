{% extends "base.html" %}
{% block title %}Cold Storage Inventory{% endblock %}

{% block content %}
<div class="container" style="max-width:1200px;">
  <div class="d-flex align-items-center justify-content-between mb-4 flex-wrap gap-3">
    <div>
      <p class="text-uppercase text-muted mb-1 small">Storage Oversight</p>
      <h2 class="fw-bold mb-0">Cold Storage Inventory</h2>
    </div>
    <div>
      <span class="badge text-bg-dark me-2">{{ inventory|length }} lots tracked</span>
      <span class="badge text-bg-warning">Filters active: {{ applied_filter_count }}</span>
      {% if perms.storage.add_coldstorageinventory %}
        <a href="{% url 'storage:inventory_add' %}" class="btn btn-primary btn-sm ms-2">Add storage record</a>
      {% endif %}
    </div>
  </div>

  <form method="get" class="row g-2 gy-3 align-items-end mb-4">
    <div class="col-md-4">
      <label class="form-label text-uppercase small fw-semibold">Product</label>
      <input type="text" name="product" class="form-control" placeholder="Filter by product"
             value="{{ active_filters.product }}">
    </div>
    <div class="col-md-4">
      <label class="form-label text-uppercase small fw-semibold">Location</label>
      <input type="text" name="location" class="form-control" placeholder="Filter by location"
             value="{{ active_filters.location }}">
    </div>
    <div class="col-md-3">
      <label class="form-label text-uppercase small fw-semibold">Expiry date</label>
      <input type="date" name="expiry" class="form-control" value="{{ active_filters.expiry }}">
    </div>
    <div class="col-md-1 d-flex gap-2">
      <button type="submit" class="btn btn-primary flex-fill">Filter</button>
      <a href="{% url 'storage:storage_list' %}" class="btn btn-outline-secondary flex-fill">Clear</a>
    </div>
  </form>

  <div class="table-responsive shadow-sm rounded-4 border border-light-subtle">
    <table class="table align-middle mb-0">
      <thead class="table-light text-uppercase small text-muted">
        <tr>
          <th scope="col">Storage ID</th>
          <th scope="col">Batch ID</th>
          <th scope="col">Product</th>
          <th scope="col">Expiry</th>
          <th scope="col">Quantity (kg)</th>
          <th scope="col">Location</th>
          <th scope="col">Status</th>
          <th scope="col">Audit trail</th>
          {% if perms.storage.change_coldstorageinventory or perms.storage.delete_coldstorageinventory %}
          <th scope="col" class="text-end">Actions</th>
          {% endif %}
        </tr>
      </thead>
      <tbody>
        {% for item in inventory %}
        <tr class="border-top">
          <td class="fw-semibold">#{{ item.storage_id }}</td>
          <td>#{{ item.production_batch.id }}</td>
          <td>{{ item.product }}</td>
          <td>{{ item.expiry_date|date:"M d, Y" }}</td>
          <td>{{ item.quantity }}</td>
          <td>
            <div class="fw-semibold">{{ item.location.name }}</div>
            <small class="text-muted">{{ item.location.get_location_type_display }}</small>
          </td>
          <td>
            {% if item.status == "expired" %}
              <span class="badge text-bg-danger">❌ Expired</span>
            {% elif item.status == "near_expiry" %}
              <span class="badge text-bg-warning text-dark">⏳ Near expiry</span>
            {% else %}
              <span class="badge text-bg-success">✅ In storage</span>
            {% endif %}
          </td>
          <td>
            <div class="small text-muted">Last touch {{ item.last_restocked|date:"M d, Y" }}</div>
            <div>{{ item.audit_notes|default:"—" }}</div>
          </td>
          {% if perms.storage.change_coldstorageinventory or perms.storage.delete_coldstorageinventory %}
          <td class="text-end">
            {% if perms.storage.change_coldstorageinventory %}
              <a href="{% url 'storage:inventory_edit' item.pk %}" class="btn btn-outline-secondary btn-sm me-2">Edit</a>
            {% endif %}
            {% if perms.storage.delete_coldstorageinventory %}
            <form method="post" action="{% url 'storage:inventory_delete' item.pk %}" onsubmit="return confirm('Delete storage record #{{ item.storage_id }}?');" class="d-inline-block">
              {% csrf_token %}
              <button type="submit" class="btn btn-outline-danger btn-sm">Delete</button>
            </form>
            {% endif %}
          </td>
          {% endif %}
        </tr>
        {% empty %}
        <tr>
          <td colspan="{% if perms.storage.change_coldstorageinventory or perms.storage.delete_coldstorageinventory %}9{% else %}8{% endif %}" class="text-center py-4 text-muted">No inventory records match the selected filters.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}
