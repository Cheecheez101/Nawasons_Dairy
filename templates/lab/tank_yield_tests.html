{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
  <h2>All Milk Yield Tests for Tank: {{ tank }}</h2>
  <table class="table table-bordered table-hover">
    <thead class="table-light">
      <tr>
        <th>Date Collected</th>
        <th>Cow</th>
        <th>Session</th>
        <th>Litres</th>
        <th>Raw Test</th>
        <th>Tank Tests</th>
      </tr>
    </thead>
    <tbody>
      {% for yield in yields %}
      <tr>
        <td>{{ yield.recorded_at|date:"Y-m-d H:i" }}</td>
        <td>{{ yield.cow.name }}</td>
        <td>{{ yield.session }}</td>
        <td>{{ yield.yield_litres }}</td>
        <td>
          {% if yield.raw_test %}
            {{ yield.raw_test.result }} ({{ yield.raw_test.tested_by }})
          {% else %}
            <span class="text-muted">No test</span>
          {% endif %}
        </td>
        <td>
          {% for test in yield.tank_tests.all %}
            {{ test.result }} ({{ test.tested_by }})<br>
          {% empty %}
            <span class="text-muted">No tests</span>
          {% endfor %}
        </td>
      </tr>
      {% empty %}
      <tr><td colspan="6" class="text-center">No yields found for this tank.</td></tr>
      {% endfor %}
    </tbody>
  </table>

  <h3 class="mt-4">Create Production Batch</h3>
  <div class="card mb-4">
    <div class="card-body">
      <form method="post" class="row g-3">
        {% csrf_token %}
        <input type="hidden" name="create_batch" value="1">
        <div class="col-md-4">
          <label class="form-label">Source tank</label>
          <input type="text" class="form-control" value="{{ tank }}" readonly>
          <input type="hidden" name="source_tank" value="{{ tank }}">
        </div>
        <div class="col-md-4">
          <label for="product_type_new" class="form-label">Product type</label>
          <select id="product_type_new" name="product_type" class="form-select">
            <option value="">-- select --</option>
            {% for pt in product_types %}
              <option value="{{ pt }}">{{ pt }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-4">
          <label for="sku" class="form-label">Sku</label>
          <input id="sku" name="sku" class="form-control" type="text" placeholder="e.g. PROD-500">
        </div>
        <div class="col-md-3">
          <label for="quantity_produced" class="form-label">Quantity produced (L)</label>
          <input id="quantity_produced" name="quantity_produced" class="form-control" type="number" step="0.01" min="0">
        </div>
        <div class="col-md-3">
          <label class="form-label">Processed by</label>
          <input type="text" class="form-control" value="{{ request.user.username }}" readonly>
        </div>
        <div class="col-md-3 d-flex align-items-center">
          <div class="form-check mt-2">
            <input class="form-check-input" type="checkbox" id="moved_to_lab" name="moved_to_lab">
            <label class="form-check-label" for="moved_to_lab">
              Moved to lab
            </label>
          </div>
        </div>
        <div class="col-12">
          <button type="submit" class="btn btn-primary">Create Batch</button>
        </div>
      </form>
    </div>
  </div>

  <h3>Production Batches from this Tank</h3>
  <div class="card mb-3">
    <div class="card-header">
      <h5 class="mb-0">üîç Filter Batches</h5>
    </div>
    <div class="card-body">
      <form method="get" class="row g-3">
        <div class="col-md-3">
          <label for="product_type" class="form-label">Product Type</label>
          <select class="form-select" id="product_type" name="product_type">
            <option value="">All Types</option>
            {% for pt in product_types %}
              <option value="{{ pt }}" {% if filters.product_type == pt %}selected{% endif %}>{{ pt }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-3">
          <label for="date_from" class="form-label">Date From</label>
          <input type="date" class="form-control" id="date_from" name="date_from" value="{{ filters.date_from }}">
        </div>
        <div class="col-md-3">
          <label for="date_to" class="form-label">Date To</label>
          <input type="date" class="form-control" id="date_to" name="date_to" value="{{ filters.date_to }}">
        </div>
        <div class="col-md-3">
          <label for="approval_status" class="form-label">Approval Status</label>
          <select class="form-select" id="approval_status" name="approval_status">
            <option value="">All Statuses</option>
            <option value="approved" {% if filters.approval_status == 'approved' %}selected{% endif %}>Approved</option>
            <option value="rejected" {% if filters.approval_status == 'rejected' %}selected{% endif %}>Rejected</option>
            <option value="pending" {% if filters.approval_status == 'pending' %}selected{% endif %}>Pending</option>
          </select>
        </div>
        <div class="col-12">
          <button type="submit" class="btn btn-primary">Apply Filters</button>
          <a href="{% url 'lab:tank_yield_tests' tank=tank %}" class="btn btn-secondary">Clear Filters</a>
        </div>
      </form>
    </div>
  </div>
  <table class="table table-bordered table-hover">
    <thead class="table-light">
      <tr>
        <th>Batch ID</th>
        <th>Product Type</th>
        <th>Quantity Produced (L)</th>
        <th>Units Produced</th>
        <th>Produced At</th>
        <th>Processed By</th>
        <th>Lab Approval</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for batch in batches %}
      <tr>
        <td>{{ batch.id }}</td>
        <td>{{ batch.product_type }}</td>
        <td>{{ batch.quantity_produced }}</td>
        <td>{{ batch.units_produced }}</td>
        <td>{{ batch.produced_at|date:"Y-m-d H:i" }}</td>
        <td>{{ batch.processed_by }}</td>
        <td>
          {% if batch.lab_approval %}
            {{ batch.lab_approval.overall_result }} ({{ batch.lab_approval.approved_by }})
          {% else %}
            <span class="text-muted">Pending</span>
          {% endif %}
        </td>
        <td>
          {% if not batch.lab_approval and perms.lab.add_labbatchapproval %}
            <a class="btn btn-outline-success btn-sm" href="{% url 'lab:approve_batch' batch_id=batch.id %}">
              ‚úÖ Approve
            </a>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}
