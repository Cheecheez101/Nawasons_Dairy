{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
  <h2>Create Tank Test for: {{ tank }}</h2>
  <p>Total litres in tank: <strong>{{ total_litres }}</strong></p>

  <form method="post">
    {% csrf_token %}
    <div class="mb-3">
      <label for="yield_id" class="form-label">Select source yield (if multiple)</label>
      <select name="yield_id" id="yield_id" class="form-select">
        <option value="">-- select yield --</option>
        {% for y in yields %}
          <option value="{{ y.id }}">{{ y.recorded_at|date:"Y-m-d H:i" }} — {{ y.cow.name|default:y.cow.cow_id }} — {{ y.yield_litres }} L</option>
        {% endfor %}
      </select>
    </div>

    <div class="mb-3">
      <label class="form-label">Result</label>
      <div>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="radio" name="result" id="res_pending" value="pending" checked>
          <label class="form-check-label" for="res_pending">Pending</label>
        </div>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="radio" name="result" id="res_approved" value="approved">
          <label class="form-check-label" for="res_approved">Approve</label>
        </div>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="radio" name="result" id="res_rejected" value="rejected">
          <label class="form-check-label" for="res_rejected">Reject</label>
        </div>
      </div>
    </div>

    <div class="mb-3">
      <label for="notes" class="form-label">Notes (optional)</label>
      <textarea name="notes" id="notes" class="form-control" rows="3"></textarea>
    </div>

    <button type="submit" class="btn btn-primary">Create Test</button>
    <a href="{% url 'lab:dashboard' %}" class="btn btn-secondary">Cancel</a>
  </form>

  <hr>
  <h4>Yields in this tank</h4>
  <table class="table table-sm">
    <thead>
      <tr>
        <th>Date</th>
        <th>Cow</th>
        <th>Litres</th>
        <th>Raw Test</th>
      </tr>
    </thead>
    <tbody>
      {% for y in yields %}
      <tr>
        <td>{{ y.recorded_at|date:"Y-m-d H:i" }}</td>
        <td>{{ y.cow.name|default:y.cow.cow_id }}</td>
        <td>{{ y.yield_litres }}</td>
        <td>{% if y.raw_test %}{{ y.raw_test.result }}{% else %}<span class="text-muted">No test</span>{% endif %}</td>
      </tr>
      {% empty %}
      <tr><td colspan="4">No yields found for this tank.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}

