{% extends "base.html" %}

{% block content %}
<div class="container-fluid mt-4">
  <div class="row">
    <div class="col-12">
      <h1 class="mb-4 text-center brand-heading">üß™ Lab Dashboard</h1>
      <p class="text-muted text-center">Monitor and manage milk yields, lab tests, tank approvals, and production batches.</p>
    </div>
  </div>

  <!-- Quick Stats Cards -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card text-white bg-primary">
        <div class="card-body">
          <h5 class="card-title">üìä Total Yields</h5>
          <h2 class="card-text">{{ yields|length }}</h2>
          <p class="card-text">Milk yields recorded</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-white bg-warning">
        <div class="card-body">
          <h5 class="card-title">‚è≥ Pending Approvals</h5>
          <h2 class="card-text">{{ pending_approvals|default:0 }}</h2>
          <p class="card-text">Batches awaiting lab approval</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-white bg-danger">
        <div class="card-body">
          <h5 class="card-title">‚ö†Ô∏è Near Expiry</h5>
          <h2 class="card-text">{{ near_expiry|default:0 }}</h2>
          <p class="card-text">Yields expiring soon</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-white bg-success">
        <div class="card-body">
          <h5 class="card-title">üè≠ Approved Tanks</h5>
          <h2 class="card-text">{{ approved_tanks|length }}</h2>
          <p class="card-text">Tanks ready for production</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Tanks Summary Section -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-info text-white">
          <h4 class="mb-0 section-header">ü™£ Tanks Summary</h4>
          <small>Overview of milk pooled in tanks and available actions</small>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-striped table-hover">
              <thead class="table-dark">
                <tr>
                  <th>Tank</th>
                  <th>Total Litres</th>
                  <th>Number of Yields</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for t in tanks_summary %}
                <tr>
                  <td><strong>{{ t.storage_tank }}</strong></td>
                  <td>{{ t.total_litres }} L</td>
                  <td>{{ t.yields_count }}</td>
                  <td>
                    {% if perms.lab.add_tankbatchtest %}
                      <a class="btn btn-outline-primary btn-sm me-2" href="{% url 'lab:create_tank_test' tank=t.storage_tank %}">
                        ‚ûï Create Tank Test
                      </a>
                    {% endif %}
                    {% if perms.lab.view_rawmilktest and t.total_litres > 0 %}
                      <a class="btn btn-outline-success btn-sm me-2" href="{% url 'production:batch_form' %}?tank={{ t.storage_tank }}">
                        üßæ Create Batch
                      </a>
                    {% endif %}
                    <a class="btn btn-outline-info btn-sm" href="{% url 'lab:tank_yield_tests' tank=t.storage_tank %}">
                      üîç View Details
                    </a>
                  </td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="4" class="text-center text-muted">No tank data available.</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Milk Yields Section -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
          <h4 class="mb-0">ü•õ Milk Yields</h4>
          <button class="btn btn-outline-light btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#filterCollapse" aria-expanded="false" aria-controls="filterCollapse">
            üîç Filters
          </button>
        </div>
        <div class="collapse" id="filterCollapse">
          <div class="card-body">
            <form method="get" class="row g-3">
              <div class="col-md-3">
                <label for="date_from" class="form-label">Date From</label>
                <input type="date" class="form-control" id="date_from" name="date_from" value="{{ filters.date_from }}">
              </div>
              <div class="col-md-3">
                <label for="date_to" class="form-label">Date To</label>
                <input type="date" class="form-control" id="date_to" name="date_to" value="{{ filters.date_to }}">
              </div>
              <div class="col-md-3">
                <label for="tank" class="form-label">Tank</label>
                <select class="form-select" id="tank" name="tank">
                  <option value="">All Tanks</option>
                  {% for t in tanks %}
                    <option value="{{ t }}" {% if filters.tank == t %}selected{% endif %}>{{ t }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-md-3">
                <label for="status" class="form-label">Status</label>
                <select class="form-select" id="status" name="status">
                  <option value="">All Statuses</option>
                  <option value="approved" {% if filters.status == 'approved' %}selected{% endif %}>Approved</option>
                  <option value="pending" {% if filters.status == 'pending' %}selected{% endif %}>Pending</option>
                  <option value="expired" {% if filters.status == 'expired' %}selected{% endif %}>Expired</option>
                  <option value="near_expiry" {% if filters.status == 'near_expiry' %}selected{% endif %}>Near Expiry</option>
                </select>
              </div>
              <div class="col-12">
                <button type="submit" class="btn btn-primary">Apply Filters</button>
                <a href="{% url 'lab:dashboard' %}" class="btn btn-secondary">Clear Filters</a>
              </div>
            </form>
          </div>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-striped table-hover">
              <thead class="table-dark">
                <tr>
                  <th>Cow</th>
                  <th>Date Collected</th>
                  <th>Litres</th>
                  <th>Tank</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for yield in yields %}
                <tr class="{% if yield.is_expired %}table-danger{% elif yield.is_near_expiry %}table-warning{% endif %}">
                  <td>{{ yield.cow.name }} ({{ yield.cow.cow_id }})</td>
                  <td>{{ yield.recorded_at|date:"M d, Y H:i" }}</td>
                  <td>{{ yield.yield_litres }} L</td>
                  <td>{{ yield.storage_tank }}</td>
                  <td>
                    {% if yield.is_expired %}
                      <span class="badge bg-danger">Expired</span>
                    {% elif yield.is_near_expiry %}
                      <span class="badge bg-warning">Near Expiry</span>
                    {% else %}
                      <span class="badge bg-success">Valid</span>
                    {% endif %}
                  </td>
                  <td>
                    {% if perms.lab.view_rawmilktest %}
                      <a class="btn btn-outline-info btn-sm me-1" href="{% url 'lab:milk_yield_tests' yield_id=yield.id %}">
                        üìä Tests
                      </a>
                    {% endif %}
                    {% if perms.lab.add_rawmilktest %}
                      <a class="btn btn-outline-primary btn-sm me-1" href="{% url 'lab:add_raw_test' yield_id=yield.id %}">
                        ‚ûï Raw Test
                      </a>
                    {% endif %}
                    {% if perms.lab.add_tankbatchtest %}
                      <a class="btn btn-outline-secondary btn-sm me-1" href="{% url 'lab:add_tank_test' yield_id=yield.id %}">
                        üß™ Tank Test
                      </a>
                    {% endif %}
                  </td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="6" class="text-center text-muted">No milk yields recorded yet.</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tank Tests Section -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-warning text-dark">
          <h4 class="mb-0">üß™ Tank Tests</h4>
          <small>Review and approve/reject tank-level tests</small>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-striped table-hover">
              <thead class="table-dark">
                <tr>
                  <th>Tank</th>
                  <th>Cow</th>
                  <th>Date</th>
                  <th>Litres</th>
                  <th>Test Result</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for test in tank_tests %}
                {% with y=test.milk_yield %}
                <tr>
                  <td><strong>{{ y.storage_tank }}</strong></td>
                  <td>{{ y.cow.name }} ({{ y.cow.cow_id }})</td>
                  <td>{{ y.recorded_at|date:"M d, Y" }}</td>
                  <td>{{ y.yield_litres }} L</td>
                  <td>
                    {% if test.result == "approved" %}
                      <span class="badge bg-success">Approved</span>
                    {% elif test.result == "rejected" %}
                      <span class="badge bg-danger">Rejected</span>
                    {% else %}
                      <span class="badge bg-secondary">Pending</span>
                    {% endif %}
                  </td>
                  <td>
                    {% if perms.lab.change_tankbatchtest and test.result == "pending" %}
                      <a class="btn btn-outline-success btn-sm me-1" href="{% url 'lab:approve_tank_test' test_id=test.id action='approve' %}">
                        ‚úÖ Approve
                      </a>
                      <a class="btn btn-outline-danger btn-sm me-1" href="{% url 'lab:approve_tank_test' test_id=test.id action='reject' %}">
                        ‚ùå Reject
                      </a>
                    {% endif %}
                    <a class="btn btn-outline-info btn-sm" href="{% url 'lab:tank_yield_tests' tank=y.storage_tank %}">
                      üîç View Tank
                    </a>
                  </td>
                </tr>
                {% endwith %}
                {% empty %}
                <tr>
                  <td colspan="6" class="text-center text-muted">No tank tests available.</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Approved Tanks for Production -->
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-success text-white">
          <h4 class="mb-0">üè≠ Approved Tanks for Production</h4>
          <small>Tanks ready for batch creation</small>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-striped table-hover">
              <thead class="table-dark">
                <tr>
                  <th>Tank</th>
                  <th>Available Litres</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for yield in approved_tanks %}
                <tr>
                  <td><strong>{{ yield.storage_tank }}</strong></td>
                  <td>{{ yield.yield_litres }} L</td>
                  <td><span class="badge bg-success">Approved</span></td>
                  <td>
                    <a class="btn btn-outline-primary btn-sm" href="{% url 'production:batch_form' %}?tank={{ yield.storage_tank }}">
                      ‚ûï Create Batch
                    </a>
                  </td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="4" class="text-center text-muted">No tanks approved for production.</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Pending Batches for Approval -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-warning text-dark">
          <h4 class="mb-0">‚è≥ Pending Batch Approvals</h4>
          <small>Batches awaiting lab approval</small>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-striped table-hover">
              <thead class="table-dark">
                <tr>
                  <th>Batch ID</th>
                  <th>Product Type</th>
                  <th>Quantity Produced</th>
                  <th>Source Tank</th>
                  <th>Produced At</th>
                  <th>Processed By</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for batch in pending_batches %}
                <tr>
                  <td>{{ batch.id }}</td>
                  <td>{{ batch.product_type }}</td>
                  <td>{{ batch.quantity_produced }}</td>
                  <td>{{ batch.source_tank }}</td>
                  <td>{{ batch.produced_at|date:"M d, Y H:i" }}</td>
                  <td>{{ batch.processed_by }}</td>
                  <td>
                    {% if perms.lab.add_labbatchapproval %}
                      <a class="btn btn-outline-success btn-sm me-1" href="{% url 'lab:approve_batch' batch_id=batch.id %}">
                        ‚úÖ Approve
                      </a>
                    {% endif %}
                  </td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="7" class="text-center text-muted">No pending batches for approval.</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
