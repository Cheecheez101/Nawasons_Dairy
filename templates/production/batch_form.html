{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
  <div class="row">
    <div class="col-md-8 offset-md-2">
      <h2 class="mb-3">Create Production Batch</h2>

      <!-- Batch form -->
      <form method="post" class="form">
        {% csrf_token %}
        <div class="mb-3">
          {{ form.as_p }}
        </div>
        <div id="max-units" class="alert alert-info mt-3" style="display:none;">
          <strong>Maximum Units:</strong> <span id="units-calc">0</span>
          <br><small>Units = (Litres available Ã— 1000) / SKU size in ml</small>
        </div>
      <!-- Messages -->
      {% if messages %}
        <div class="mt-3">
          <ul class="list-group">
            {% for message in messages %}
              <li class="list-group-item list-group-item-{{ message.tags }}">
                {{ message }}
              </li>
            {% endfor %}
          </ul>
        </div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}

      <script>
        function calculateUnits() {
          const tankSelect = document.getElementById('id_source_tank');
          const skuSelect = document.getElementById('id_sku');
          const unitsDiv = document.getElementById('max-units');
          const unitsSpan = document.getElementById('units-calc');

          if (tankSelect.selectedIndex > 0 && skuSelect.selectedIndex > 0) {
            const tankText = tankSelect.options[tankSelect.selectedIndex].text;
            const skuText = skuSelect.options[skuSelect.selectedIndex].text;

            // Parse litres from "Tank A: 150 litres"
            const litresMatch = tankText.match(/(\d+(\.\d+)?)/);
            const litres = litresMatch ? parseFloat(litresMatch[0]) : 0;

            // Parse size from sku, e.g., "MAL A-CL-500" -> 500
            const skuMatch = skuText.match(/-(\d+)/);
            const size = skuMatch ? parseInt(skuMatch[1]) : 0;

            if (litres > 0 && size > 0) {
              const units = Math.floor((litres * 1000) / size);
              unitsSpan.textContent = units;
              unitsDiv.style.display = 'block';
            } else {
              unitsDiv.style.display = 'none';
            }
          } else {
            unitsDiv.style.display = 'none';
          }
        }

        document.getElementById('id_source_tank').addEventListener('change', calculateUnits);
        document.getElementById('id_sku').addEventListener('change', calculateUnits);
      </script>
