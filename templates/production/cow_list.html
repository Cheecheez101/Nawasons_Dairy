{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
  <div class="d-flex flex-wrap align-items-center gap-3 mb-3">
    <div>
      <h1 class="mb-1">Cow Dashboard</h1>
      <p class="text-muted mb-0">Monitor herd health and drill into every recorded yield.</p>
    </div>
    <div class="ms-auto d-flex flex-wrap gap-2">
      <a class="btn btn-primary" href="{% url 'production:cow_create' %}">‚ûï Register Cow</a>
      <a class="btn btn-secondary" href="{% url 'production:yield_create' %}">üçº Record New Yield</a>
    </div>
  </div>

  <div class="card shadow-sm mb-4">
    <div class="card-header bg-white d-flex justify-content-between align-items-center flex-wrap gap-2">
      <h2 class="h5 mb-0">Cow overview</h2>
      <span class="badge bg-secondary">{{ cows|length }} registered</span>
    </div>
    
    <!-- Cow Filters -->
    <div class="card-body border-bottom bg-light">
      <form method="get" class="row g-2 align-items-end">
        <div class="col-md-3">
          <label for="cow_search" class="form-label small text-muted">Search Cow</label>
          <input type="text" id="cow_search" name="cow_q" class="form-control form-control-sm" 
                 placeholder="e.g. Daisy or COW-001" 
                 value="{{ request.GET.cow_q }}">
        </div>
        <div class="col-md-2">
          <label for="breed" class="form-label small text-muted">Breed</label>
          <select id="breed" name="breed" class="form-select form-select-sm">
            <option value="">All Breeds</option>
            <option value="friesian" {% if request.GET.breed == 'friesian' %}selected{% endif %}>Friesian</option>
            <option value="jersey" {% if request.GET.breed == 'jersey' %}selected{% endif %}>Jersey</option>
            <option value="ayrshire" {% if request.GET.breed == 'ayrshire' %}selected{% endif %}>Ayrshire</option>
            <option value="guernsey" {% if request.GET.breed == 'guernsey' %}selected{% endif %}>Guernsey</option>
            <option value="sahiwal" {% if request.GET.breed == 'sahiwal' %}selected{% endif %}>Sahiwal</option>
            <option value="brown_swiss" {% if request.GET.breed == 'brown_swiss' %}selected{% endif %}>Brown Swiss</option>
            <option value="holstein" {% if request.GET.breed == 'holstein' %}selected{% endif %}>Holstein</option>
            <option value="crossbreed" {% if request.GET.breed == 'crossbreed' %}selected{% endif %}>Crossbreed</option>
          </select>
        </div>
        <div class="col-md-2">
          <label for="health" class="form-label small text-muted">Health Status</label>
          <select id="health" name="health" class="form-select form-select-sm">
            <option value="">All</option>
            <option value="healthy" {% if request.GET.health == 'healthy' %}selected{% endif %}>Healthy</option>
            <option value="monitor" {% if request.GET.health == 'monitor' %}selected{% endif %}>Monitor</option>
            <option value="sick" {% if request.GET.health == 'sick' %}selected{% endif %}>Needs Attention</option>
          </select>
        </div>
        <div class="col-md-2">
          <label for="active_status" class="form-label small text-muted">Status</label>
          <select id="active_status" name="is_active" class="form-select form-select-sm">
            <option value="">All Cows</option>
            <option value="1" {% if request.GET.is_active == '1' %}selected{% endif %}>Active Only</option>
            <option value="0" {% if request.GET.is_active == '0' %}selected{% endif %}>Inactive Only</option>
          </select>
        </div>
        <div class="col-md-3 d-flex gap-2">
          <button type="submit" class="btn btn-primary btn-sm flex-grow-1">
            <i class="bi bi-funnel me-1"></i> Filter
          </button>
          <a href="{% url 'production:cow_list' %}" class="btn btn-outline-secondary btn-sm">Reset</a>
        </div>
      </form>
    </div>
    
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-striped align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th>Cow ID</th>
              <th>Cow name</th>
              <th>Breed</th>
              <th>Health</th>
              <th>Today's yield (L)</th>
              <th class="text-end">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for cow in cows %}
            <tr>
              <td><code>{{ cow.cow_id }}</code></td>
              <td>{{ cow.name }}</td>
              <td>{{ cow.breed }}</td>
              <td>{{ cow.get_health_status_display }}</td>
              <td>
                {% if cow.today_yield %}
                  {{ cow.today_yield|floatformat:2 }} L
                {% else %}
                  <span class="text-muted">0.00 L</span>
                {% endif %}
              </td>
              <td class="text-end">
                <div class="d-flex justify-content-end gap-2">
                  <a class="btn btn-sm btn-outline-primary" href="{% url 'production:cow_edit' cow.pk %}">Edit</a>
                  <form method="post" action="{% url 'production:cow_delete' cow.pk %}" onsubmit="return confirm('Delete cow {{ cow.name|default:cow.cow_id }}? This will also delete all associated milk yields.');">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
                  </form>
                </div>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="6" class="text-center text-muted py-4">No cows registered yet.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <section>
    <div class="d-flex flex-wrap align-items-center gap-3 mb-3">
      <div>
        <h2 class="h4 mb-0">Milk yield log</h2>
        <small class="text-muted">{{ yield_summary.count }} entries ¬∑ {{ yield_summary.volume|floatformat:2 }} L captured</small>
      </div>
      <div class="ms-auto d-flex flex-wrap gap-2">
        <a class="btn btn-outline-secondary" href="{% url 'production:cow_list' %}">Reset filters</a>
        <a class="btn btn-success" href="{% url 'production:yield_export' %}{% if request.GET %}?{{ request.GET.urlencode }}{% endif %}">Export Excel</a>
      </div>
    </div>

    <form method="get" id="yield-filter-form" class="card card-body shadow-sm mb-3">
      <div class="row g-3 align-items-end">
        <div class="col-md-4">
          <label for="search" class="form-label">Search cow</label>
          <input type="text" id="search" name="q" class="form-control" placeholder="Name or ear tag" value="{{ filters.search }}">
        </div>
        <div class="col-md-3">
          <label for="date_from" class="form-label">From date</label>
          <input type="date" id="date_from" name="date_from" class="form-control" value="{{ filters.date_from }}">
        </div>
        <div class="col-md-3">
          <label for="date_to" class="form-label">To date</label>
          <input type="date" id="date_to" name="date_to" class="form-control" value="{{ filters.date_to }}">
        </div>
        <div class="col-md-2">
          <label class="form-label text-white">Apply</label>
          <button type="submit" class="btn btn-primary w-100">Apply filters</button>
        </div>
      </div>
      <hr class="my-3">
      <div>
        <span class="text-muted small d-block mb-2">Session filter</span>
        <div class="btn-group" role="group" aria-label="Session filter">
          <input type="radio" class="btn-check" name="session" id="session-all" value="" {% if not filters.session %}checked{% endif %}>
          <label class="btn btn-outline-secondary" for="session-all">All</label>
          {% for key, label in session_choices %}
            <input type="radio" class="btn-check" name="session" id="session-{{ key }}" value="{{ key }}" {% if filters.session == key %}checked{% endif %}>
            <label class="btn btn-outline-secondary" for="session-{{ key }}">{{ label }}</label>
          {% endfor %}
        </div>
      </div>
    </form>

    <div class="card shadow-sm">
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th>Milk clerk</th>
              <th>Cow</th>
              <th>Breed</th>
              <th>Session</th>
              <th>Date &amp; time</th>
              <th>Yield (L)</th>
              <th class="text-end">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for entry in yield_rows %}
            <tr>
              <td>
                {% if entry.recorded_by %}
                  {{ entry.recorded_by.get_full_name|default:entry.recorded_by|default:"‚Äî" }}
                {% else %}
                  <span class="text-muted">‚Äî</span>
                {% endif %}
              </td>
              <td>
                <div class="fw-semibold">{{ entry.cow.name|default:entry.cow.cow_id }}</div>
                <small class="text-muted">{{ entry.cow.cow_id }}</small>
              </td>
              <td>{{ entry.cow.breed }}</td>
              <td>{{ entry.get_session_display }}</td>
              <td>{{ entry.recorded_at|date:"M d, Y H:i" }}</td>
              <td>{{ entry.yield_litres|floatformat:2 }}</td>
              <td class="text-end">
                <div class="d-flex justify-content-end gap-2">
                  <a class="btn btn-sm btn-outline-primary" href="{% url 'production:yield_edit' entry.id %}">Edit</a>
                  <form method="post" action="{% url 'production:yield_delete' entry.id %}" onsubmit="return confirm('Delete this milk yield entry?');">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
                  </form>
                </div>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="7" class="text-center text-muted py-4">No yield entries match the selected filters.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </section>
</div>
{% endblock %}
